<!-- 


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote Movie</title>
</head>
<body>
    <h2>Vote for a Movie</h2>
    
    <div>
        <h3>Movie 1</h3>
        <h4>${movie1.title}</h4>
        <p>${movie1.description}</p>
        <img src="/images/${movie1.title}.jpg" alt="${movie1.title}" />
    </div>

    <div>
        <h3>Movie 2</h3>
        <h4>${movie2.title}</h4>
        <p>${movie2.description}</p>
        <img src="/images/${movie2.title}.jpg" alt="${movie2.title}" />
    </div>

  
</body>
</html>
 -->
 
 
 
 
 <%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
 <%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Movie Voting</title>
<style>
.main-container {
  width: 80%;
  margin: 0 auto;
  padding: 20px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  border-radius: 10px;
}
.content-container {
  display: flex;
  justify-content: space-between;
}
.movies-container, .vote-container {
  flex: 1;
  padding: 20px;
  border: 1px solid #ddd;
  border-radius: 5px;
}
.movie-info {
  display: flex;
  margin-bottom: 20px;
  padding: 10px;
  border: 1px solid #eee;
  border-radius: 5px;
}
.movie-details {
  margin-left: 20px;
}
img {
  width: 150px;
  height: auto;
}
#vote-form {
  display: flex;
  flex-direction: column;
}
.vote-option {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}
.vote-option label {
  display: flex;
  align-items: center;
}
.vote-option input[type="radio"] {
  margin-right: 10px;
}
button {
  padding: 10px;
  background-color: #4CAF50;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}
#view-results {
  margin-top: 20px;
  background-color: #008CBA;
  width: 100%;
}
.vote-button {
  display: flex;
  justify-content: flex-end;
  margin-top: 10px;
}
.chart-container {
  width: 100%;
  max-width: 400px;
  margin: 0 auto;
}
#vote-chart {
  width: 100%;
  height: 300px;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<jsp:include page="../../layout/title.jsp"/>
<div class="main-container">
  <div class="content-container">
  <div class="movies-container">
  <div class="movie-info">
    <img src="/images/${movie1.title }.jpg" alt="Movie 1">  
    <div class="movie-details">
     <h2>${movie1.title}</h2>
      <p>${fn:substring(movie1.description, 0, 100)}...</p>  <!-- 첫 100자만 출력 -->
    </div>
  </div>
  <div class="movie-info">
    <img src="/images/${movie2.title }.jpg" alt="Movie 2"> 
    <div class="movie-details">
      <h2>${movie2.title}</h2>
      <p>${fn:substring(movie2.description, 0, 100)}...</p>  <!-- 첫 100자만 출력 -->
   </div>
  </div>
</div>
  <div class="vote-container">
      <div id="vote-form-container">
        <form id="vote-form">
          <div class="vote-option">
            <label>
              <input type="radio" name="movie" value="movie1">
              <span>${movie1.title}</span>
            </label>
          </div>
          <div class="vote-option">
            <label>
              <input type="radio" name="movie" value="movie2">
              <span>${movie2.title}</span>
            </label>
          </div>
          <div class="vote-button">
            <button id="vote-button" type="submit">투표</button>
          </div>
        </form>
        <button id="view-results">결과 먼저 보기</button>
      </div>
      <div id="results-container" style="display:none;">
        <div class="chart-container">
          <canvas id="vote-chart"></canvas>
        </div>
        <button id="back-to-vote">다시 투표하기</button>
      </div>
    </div>
  </div>
</div>




<script>
let myChart = null;

function showResults(movie1Votes, movie2Votes, movie1Title, movie2Title) {
    document.getElementById('vote-form-container').style.display = 'none';
    document.getElementById('results-container').style.display = 'block';

    const ctx = document.getElementById('vote-chart').getContext('2d');

    if (myChart) {
        myChart.destroy();
    }

    myChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: [movie1Title, movie2Title], // 영화 이름으로 라벨 설정
            datasets: [{
                data: [movie1Votes, movie2Votes],
                backgroundColor: ['#FF6384', '#36A2EB']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            title: {
                display: true,
                text: '영화 투표 결과'
            }
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // JSP에서 movie1, movie2 정보를 전달받아 차트를 바로 그리기 위해
    const movie1Votes = ${movie1Votes}; // 서버에서 전달한 movie1Votes 값
    const movie2Votes = ${movie2Votes}; // 서버에서 전달한 movie2Votes 값
    const movie1Title = '${movie1.title}'; // JSP에서 movie1.title을 전달받아 변수에 저장
    const movie2Title = '${movie2.title}'; // JSP에서 movie2.title을 전달받아 변수에 저장

    // 서버에서 받은 투표 결과로 차트를 그리기
    showResults(movie1Votes, movie2Votes, movie1Title, movie2Title);

    // 투표 폼이 제출되면 서버로 투표 데이터를 전송하고 결과를 갱신
    document.getElementById('vote-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const selectedMovie = document.querySelector('input[name="movie"]:checked').value;

        // 선택된 영화 ID로 서버에 투표 요청
        fetch('/voteMovie', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ movieId: selectedMovie })
        })
        .then(response => response.json())
        .then(data => {
            // 서버에서 새로운 투표 결과를 받아와서 차트를 갱신
            showResults(data.movie1Votes, data.movie2Votes, data.movie1Title, data.movie2Title);
        })
        .catch(error => {
            console.error('Error voting:', error);
        });
    });

    // "결과 먼저 보기" 버튼 클릭 시 투표 결과 보기
    document.getElementById('view-results').addEventListener('click', function() {
        // 서버에서 전달된 초기 투표 결과를 기반으로 차트를 그리기
        showResults(movie1Votes, movie2Votes, movie1Title, movie2Title);
    });

    // "다시 투표하기" 버튼 클릭 시 투표 폼을 다시 보이게 함
    document.getElementById('back-to-vote').addEventListener('click', function() {
        document.getElementById('results-container').style.display = 'none';
        document.getElementById('vote-form-container').style.display = 'block';
    });
});
</script>

</body>
</html>
 